FROM noetic-desktop:latest

# Latest boost has an issue https://github.com/ros/ros-overlay/issues/986
# So we mask it for now so we can build roscpp

RUN $PREFIXED emerge =dev-python/setuptools-60.5.0

RUN mkdir -p $EPREFIX/etc/portage/patches/ros-noetic/catkin
ADD catkin_patchs/0001-Add-lib64-to-LD_LIBRARY_PATH.patch $EPREFIX/etc/portage/patches/ros-noetic/catkin/0001-Add-lib64-to-LD_LIBRARY_PATH.patch
ADD catkin_patchs/0002-Add-DESTDIR-for-Gentoo.patch $EPREFIX/etc/portage/patches/ros-noetic/catkin/0002-Add-DESTDIR-for-Gentoo.patch
ADD catkin_patchs/0003-Force-non-debian-layout.patch $EPREFIX/etc/portage/patches/ros-noetic/catkin/0003-Force-non-debian-layout.patch
ADD catkin_patchs/0004-ADd-CATKIN_PREFIX_PATH-if-not-found.patch $EPREFIX/etc/portage/patches/ros-noetic/catkin/0004-ADd-CATKIN_PREFIX_PATH-if-not-found.patch

RUN echo "=dev-libs/console_bridge-9999 **">> $EPREFIX/etc/portage/package.accept_keywords

RUN $PREFIXED COLLISION_IGNORE="/usr" linux32 emerge ros-noetic/ros_base || true

RUN COLLISION_IGNORE="/tmp/gentoo/usr" FEATURES="-collision-detect -protect-owned" $PREFIXED emerge  ros-noetic/ros_base

ENTRYPOINT ["/bin/bash"]