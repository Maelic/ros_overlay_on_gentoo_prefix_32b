# Pull ros-kinetic/ros_base already emerged and the first part to emerge desktop
FROM awesomebytes/roogp_32b_ros_kinetic_desktop_1

# Hack meanwhile this gets solved: https://github.com/ros/ros-overlay/issues/913
RUN rm $EPREFIX/usr/local/portage/ros-kinetic/orocos_kdl/files/*
RUN RUN cd $EPREFIX/usr/local/portage/ros-kinetic/orocos_kdl; $PREFIXED ebuild $EPREFIX/usr/local/portage/ros-kinetic/orocos_kdl/*.ebuild manifest

RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/tf2
COPY 0001-Remove-signals-to-enable-build.patch $EPREFIX/etc/portage/patches/ros-kinetic/tf2

RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/tf
COPY 0001-Remove-signals-so-to-build-with-boost-1.71.0.patch $EPREFIX/etc/portage/patches/ros-kinetic/tf/0001-Remove-signals-so-to-build-with-boost-1.71.0.patch

RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/rviz
COPY 0001-Rviz-remove-signals-as-boost-1.71.0-bug.patch $EPREFIX/etc/portage/patches/ros-kinetic/rviz/0001-Rviz-remove-signals-as-boost-1.71.0-bug.patch

# Even though it's not part of desktop, perception needs it
# TODO: move it to a perception release
RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/laser_assembler
COPY 0001-laser_assembler-remove-signals-for-boost-1.71.9.patch $EPREFIX/etc/portage/patches/ros-kinetic/laser_assembler/0001-laser_assembler-remove-signals-for-boost-1.71.9.patch

# Same as laser_assembler but for laser_filters
RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/laser_filters
COPY 0001-laser_filters-signals-boost-1.71.0-patch.patch $EPREFIX/etc/portage/patches/ros-kinetic/laser_filters/0001-laser_filters-signals-boost-1.71.0-patch.patch

# Same for image_view as the laser_assembler
RUN mkdir -p $EPREFIX/etc/portage/patches/ros-kinetic/image_view
COPY 0001-image_view-signals-boost-1.71.0-bug-fix.patch $EPREFIX/etc/portage/patches/ros-kinetic/image_view/0001-image_view-signals-boost-1.71.0-bug-fix.patch

# Numpy doesn't support Python 2.7 anymore
# and we are still pending on migrating to Python 3 (as ROS is)
# ros-kinetic/opencv_bridge fails to emerge with:
# ImportError: No module named numpy
# CMake Error at src/CMakeLists.txt:25 (message):
#   Could not determine the NumPy include directory, verify that NumPy was
#   installed correctly.
# So we install the latest Python2 compatible numpy version
RUN echo ">dev-python/numpy-1.17" >> $EPREFIX/etc/portage/package.mask

# Setup desktop (237 packages)
RUN $PREFIXED emerge ros-kinetic/desktop || true

# Extra trick needed as qmake points to qtchooser for Rviz, but we can only do it
# when we already have QT5
# so we let ros-kinetic/desktop fail once and do this
RUN cd /tmp/gentoo/usr/bin && \
    unlink qmake && \
    ln -s /tmp/gentoo/usr/lib/qt5/bin/qmake qmake
RUN $PREFIXED emerge ros-kinetic/desktop


# Create the bin packages
RUN $PREFIXED quickpkg \"*/*\" --include-config y --include-unmodified-config y

ENTRYPOINT ["/bin/bash"]
